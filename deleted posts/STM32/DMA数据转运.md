---
title: DMA数据转运
date: 2024-06-12 14:10:31
tags: STM32
---

## DMA数据转运

DMA（direct memory access）直接存储器存取，实现存储器与存储器、存储器与外设之间的数据转运。

12个独立可配置通道：DMA1（7个），DMA2（5个）。其中STM32F103C8T6仅有DMA1的7个通道。

#### DMA结构框图：

<img src="https://s2.loli.net/2024/06/12/aNjzrom7b6nSsHL.png" alt="image-20240612141447251" style="zoom: 67%;" />

外设通过发送DMA请求，使能DMA转运。不同通道从设定的地址中读取数据，存储到设定的目的地址中。在转运过程中，如果出现通道拥挤，DMA的仲裁器就会根据分配的优先级**分时复用**DMA总线传输数据。

注意，对于CPU和DMA的直接读取而言，Flash中的内容是**只读**的，如果将目的地址设为flash中的地址，就会报错。

#### DMA基本结构：

<img src="https://s2.loli.net/2024/06/12/YwbgzStHLiq5cOd.png" alt="image-20240612142300212" style="zoom:67%;" />

**起始地址**：即第一个数据的源地址/目的地址

**数据宽度**：有三个可选宽度，分别为8bit（Byte），16bit（HalfWord），32bit（Word）。

**地址是否自增**：即转运完一个数据后，源/目的地址位是否+1；如果不加，则从同一位置读取/转运到同一位置。在数据需要不断更新的任务中，地址不需要自增；在需要存储所有数据的任务中，目的地址需要自增。

**传输计数器**：需要转运的次数，每转运一次，计数-1，归0后结束转运。

**自动重装器**：在传输计数器归0后重新加载到初始值，实现循环转运。

**M2M**：选择由软件触发还是硬件触发。

**软件触发**：无触发条件，一直执行到将传输计数器清零后停止，所以不与自动重装器一起使用，否则无法结束循环。一般适用于存储器到存储器的转运。

**硬件触发**：需要一定的触发条件，再执行转运。

**DMA转运的三个条件**：开关控制使能，传输计数器大于0，触发源发送触发信号。注意，传输计数器的值不能再开关控制使能时写入；只能先关闭开关，再改变计数器的值。

#### DMA1请求映像：

<img src="https://s2.loli.net/2024/06/12/EIVwaGpqQXAvcrH.png" alt="image-20240612143535351" style="zoom:80%;" />

**外设请求只能由对应的DMA通道传输**，软件触发则可以任意选择。

另外，在转运数据的时候，可能存在源端宽度与目标宽度不一致的情况。原则为：若源端宽度大于目标宽度，则舍弃高位；若源端宽度小于目标宽度，则在高位补0。

#### ADC扫描模式+DMA

ADC最大的缺陷在于数据覆盖，通过DMA的数据转运就可以很好地解决这个问题。

<img src="https://s2.loli.net/2024/06/12/COos7gNuGSdYbrE.png" alt="image-20240612144630432" style="zoom:67%;" />

ADC扫描模式中，每个通道结束AD转换后，数据被存到ADC_DR数据寄存器当中；同时ADC硬件发送触发信号，DMA将ADC_DR中的数据传输到存储器中，同时目的寄存器地址+1，指向新地址等待下一次转运。
