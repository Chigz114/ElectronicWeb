---
title: MP2：移植MPU6050
date: 2025-01-15 15:30:48
tags: 平衡小车
top_img: https://img.alicdn.com/i4/2214283073185/O1CN01DUaXAl1ZOmI9WZHla_!!2214283073185.jpg
cover: https://img.alicdn.com/i4/2214283073185/O1CN01DUaXAl1ZOmI9WZHla_!!2214283073185.jpg
---

## MP2：移植MPU6050

　　MPU6050是平衡小车的核心传感元件。

　　MPU6050是六轴姿态传感器，由三轴加速度和三轴角速度组成。加速度计在物体快速移动时，因物体本身存在加速度，导致由加速度解算得到的物体姿态并不准确。而角速度计虽然在物体旋转时可以较为准确地得到旋转角度（即各个方向角速度对时间的积分），却在稳定时有一定的稳态误差；这使得其对时间积分后会逐渐扩大误差。

　　所以MPU6050结合了这两种传感器，我们可以取这两种传感器各自的长处，得到相对可靠的姿态。

　　本节不对数据处理作详细解释，这是MP3的主要内容。本节将专注于引脚定义的移植。



　　本节的主要任务是读取MPU6050中的数值，并将其显示在OLED显示屏上，要求将寄存器数值转化为可读的单位，加速度值为m/s²，角速度值为弧度制。要求读取频率达到25Hz，50Hz为宜；频率越高越好，200Hz理论可行。

　　另外，因为数据处理需要定时进行，所以在本MP中，请一并移植定时器中断，并将频率控制为与MPU6050采样频率相同。时钟不需要修改，沿用TIM2时钟，如果修改，可能挤占后续调用的时钟。

　　注意，请将该程序移植到MP1的同一个工程中。



　　**请先尝试自行完成，如果遇到困难，再看下面的提示。**











　　为了操作方便，第一步先移植定时器中断。这里以50Hz为例。这一步几乎不会遇到困难，移植即用。主要是要理解TIM时钟的分频计算。在江协科技中，时钟主频被设置为72MHz，所以，为了得到一个50Hz的中断，计算可知，要除以72，再除以20000。为了看着平均一点（不影响实际效果），可以将两个寄存器分别设置为1000-1和1440-1（注意这里的-1，时钟默认是1分频，如果将寄存器设置为n，则为n+1分频）。

　　在这些都配置完成后，在main函数中调用定时中断，在中断中使用自增，并在while循环中调用OLED显示当前数值。由此验证时钟是否设置正确。



　　接下来将移植MPU6050。这里需要移植5个函数，分别是：

```
MPU6050.c
MPU6050.h
MPU6050_Reg.h
MyI2C.c
MyI2C.h
```

　　这些函数都在10-1软件I2C读取MPU6050的Hardware文件夹中。

　　查看S28A引脚定义表可以得知，MPU6050与单片机的通信由PB8，PB9引脚完成。于是找到MyI2C中的对应定义，将所有引脚修改完成。

　　接下来就是修改采样频率，在MPU6050.c文件中找到采样率分频寄存器初始化代码：

```c
MPU6050_WriteReg(MPU6050_SMPLRT_DIV, 0x04);		//采样率分频寄存器，配置采样率200Hz
```

　　采样频率不必与时钟中断频率相同，但需要大于等于时钟中断频率，最好是其整数倍。上方代码示例中将其定义为200Hz，也可以修改寄存器配置，将其定义为50Hz，100Hz等等。

　　查找MPU6050寄存器配置表可知，其最高采样率为8000Hz，在配置低通滤波器DLPF后，最高采样率为1000Hz。我建议你们使能低通滤波器，减小数据波动。在使能低通滤波器后，分频是以1000Hz为基础的，例如，需要50Hz的采样频率，则分频寄存器设置为20-1。另外需要注意，寄存器的设置是16进制的，20-1=19=0x13。

　　此外，我们还需要配置角速度计和加速度计的量程。基于平衡小车的需要，加速度只需要能测量1G的重力加速度即可，所以将量程配置为2G，提高分辨率①。对于角速度，因为小车需要应对角度的突变，角速度值可能很大，所以将量程设置到最大，2000°/s。具体的数值设置可以参考寄存器配置表，也可以看下方的代码段：

```c
MPU6050_WriteReg(MPU6050_GYRO_CONFIG, 0x18);//陀螺仪配置寄存器，选择满量程为±2000°/s
MPU6050_WriteReg(MPU6050_ACCEL_CONFIG, 0x00);//加速度计配置寄存器，选择满量程为±2g
```

　　之后，将MPU6050的读取函数配置到定时器中断函数中，通过OLED屏幕读出，验证配置的正确性。接下来只需将得到的数值进行单位转换，得到标准单位的数值即可。

　　Accel = Reg_Acc / 1671.84;

　　Gyro = Reg_Gyro / 939.8;

　　注意，通过MPU6050_GetData()函数得到的数据是int16_t类型的，为了提高计算精度，需要将单位转换后的数据设置为float单精度浮点数类型。

　　至此，所有相关配置完成。





附注：

　　这里需要指出的是，分辨率与精度并不等价。对于传感器，分辨率意味着可以在更小的物理量上测量。在精度超过分辨率的高精度传感器中，提高分辨率就可以提高测量的精度。但是，在MPU6050中，测量的精度不高，即使提高了分辨率，也对于精度提升不大。

　　举个例子，我们先用一根绳子测量一张桌子的长度，在绳子的两端用笔做记号，再用尺子测量绳子的长度，得到桌子的长度。测量中，虽然尺子的分度值（分辨率）达到了1mm，但我们在用绳子标记桌子长度时，误差有1cm。那么，整体的测量精度仍为±1cm。

　　但是，即使噪声较大，较高的精度至少可以精细地刻画出噪声的数值，降低后续数据处理的不确定性。所以，我还是推荐各位使用2G的量程。