---
title: MP7：PID控制（Hard one）
date: 2025-02-06 15:06:08
tags: 平衡小车
top_img: https://img.alicdn.com/i4/2214283073185/O1CN01DUaXAl1ZOmI9WZHla_!!2214283073185.jpg
cover: https://img.alicdn.com/i4/2214283073185/O1CN01DUaXAl1ZOmI9WZHla_!!2214283073185.jpg
---

## MP7：PID控制（Hard one）

　　通过卡尔曼滤波，我们已经得到了小车的姿态；通过PWM波，我们也可以控制小车车轮的转速；通过电机编码盘，我们也可以读取小车当前的速度。但是，如何根据当前的姿态值设定合适的速度值，使小车可以快速回正，且不会出现过冲（可理解为加速度过大，使小车倒向另一边）的情况？

　　一个很直观的想法是：假设小车当前的倾角为θ，那么只需要设置小车电机占空比为pwm = α * θ，即，将小车的倾角乘以一个系数α，倾角越大，电机速度越大。大多情况下，仅使用这一个函数，即可得到较为合理的数值，实现闭环控制的目的。

　　但是，让我们考虑一下弹簧振子，将上式中的α看作弹簧的劲度系数，θ看作弹簧的伸长量。我们是否可以类比得到，在仅有比例控制，且阻尼较小的情况下，系统很难回到稳定状态，会在较长时间内处于周期性运动中。而且，若系统同时受到外部干扰，这样仅依靠比例系数的响应甚至可能导致系统无法回到稳态，进而发散。

　　**这样反馈量与当前误差量成正比的闭环控制方法，即是PID控制中的P（比例项）。**

　　那么，为了避免发生过冲，我们还需要在小车倾角改变速度过快时减缓其改变速度。对应的，我们需要单独读取小车目前的角速度，并用其补偿较大的倾角导致的过大加速度。公式的大致形式为：
$$
Duty_{PWM} = Kp * angle - Kd * gyro
$$
　　这里的负号指的是Kd项与Kp项符号相反，用于缓冲Kp项过大的变化速度。在编程时，需要注意实际读取的gyro角速度值的正负。如果取反，可能反而加剧过冲。

　　**这种通过控制量（本例中小车的倾角）的微分项（角速度）来缓和比例项造成的过冲的项，即是PID控制中的D（微分项）。**

　　因为本题中，只需要将小车停在原地，所以积分项并未使用到。一般来说，在速度控制中，积分项较为常用；而在位置控制中，积分项几乎必然导致过冲。这是由积分项的原理决定的。这里用一段PI环速度控制代码来解释PID中的I项的作用：

```c
int Velocity(int encoder_left,int encoder_right)
{  
	static float velocity,Encoder_Least,Encoder_bias;
	static float Encoder_Integral;
 //================速度PI控制器=====================//	
	Encoder_Least = Target_Velocity - (encoder_left+encoder_right); 
	Encoder_bias *= 0.71;										//一阶低通滤波器，减缓速度变化
	Encoder_bias += Encoder_Least*0.29; 
	Encoder_Integral += Encoder_bias;							//速度误差积分
	if(Encoder_Integral>1500)  	Encoder_Integral=1500;			//积分限幅
	if(Encoder_Integral<-1500)	  Encoder_Integral=-1500;		//积分限幅
	velocity = -Encoder_bias*V_Kp/100 - Encoder_Integral*V_Ki/100;	//速度控制

	return velocity;
}
```

关于低通滤波器的两行代码，我会在文末解释。此处，我们得到了Encoder_bias，即目标速度值与当前速度值的残差。但是，因为残差值过小，我们无法通过P项使速度达到目标（这可能是阻尼等因素导致的，或电压过低无法启动电机）。因此，我们需要使用积分项，使其在短时间内足够小，不至于让它影响P项使系统趋向于稳态；但又要有足够的大小，使系统离稳态仍有微小差距时，通过积分项放大这一误差，使之得到调整。

　　这一项可以加到当前的平衡小车内，只需将Target_Velocity设为0，并给V_Kp和V_Ki赋以合适的值即可。可以作为PD环的辅助项，但需注意，其值至少比PD环小一个数量级，以免对稳态造成过大影响。

　　至此理论上可以完成代码编写。且代码编写完成后，小车应当可以保持平衡。调参是本MP中的主要难点，请务必先尝试自行调参。如果遇到困难，也可以看卖家给的材料中，**附送资料V3.0→平衡小车上手使用及开发视频教程→平衡小车PID参数调节讲解**。如尝试调参后，小车仍无法平衡，可参考下面的经验性参数：





　　在单片机主频为72MHz条件下，设置采样频率（同系统主时钟）为25Hz。该条件下，PD环的Kp参数为3200，Kd参数为16。PI环的V_Kp为245，V_Ki为1.5。

　　当然，此处的PI环理论上并不必要，但需要将相应的参数加到PD环中。

　　下附我编写代码中简单的PD环：

```c
int16_t get_pwm(float angle, float gyro){
	
	int16_t pwm;
	pwm = (int16_t)(Kp * angle / 100 + Kd * gyro / 100);
	
	if(pwm > 1000) pwm = 1000;
	else if(pwm < -1000) pwm = -1000;
		
	return pwm;
}
```





　　关于代码中的低通滤波器：因为采样得到的速度值可能存在误差，进而导致得到的P环反馈变化过大，使系统不稳定。一个简易的低通滤波器可以缓和相邻采样间速度的过大变化。

