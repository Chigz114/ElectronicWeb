---
title: MP3：卡尔曼滤波器
date: 2025-01-20 17:41:16
tags: 平衡小车
top_img: https://img.alicdn.com/i4/2214283073185/O1CN01DUaXAl1ZOmI9WZHla_!!2214283073185.jpg
cover: https://img.alicdn.com/i4/2214283073185/O1CN01DUaXAl1ZOmI9WZHla_!!2214283073185.jpg
---

## MP3：卡尔曼滤波器（Hard one）

　　MP2中，我们发现，通过直接从MPU6050传感器中得到的加速度和角速度值噪声很大。且稳定状态下，相较于正常的加速度和角速度值也有较大偏移（即传感器固定不动时，角速度不为0；三轴加速度的模值不为g，加速度方向与实际有偏移）。

这一节的目的有两个：

①去除传感器在稳定状态下的数值偏移，使之与实际情况相符。

②降低传感器采集数值的高频噪声（即两次相邻采样之间的数据波动）。



　　第一个问题很好解决，只需用一些最原始的办法（请先自行思考）

　　第二个问题较为复杂，也有很多的解决办法。包括使用MPU6050自带的DMP库，四元数解算、卡尔曼滤波等。测试下来，DMP解算精度相对较低，四元数解算则编程略显复杂。卡尔曼滤波精度较高且适用范围较广。



### 卡尔曼滤波器介绍

　　关于原理部分，建议听B站up主Dr.Can的视频1~4。[【卡尔曼滤波器】1_递归算法_Recursive Processing_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1ez4y1X7eR/?spm_id_from=333.999.0.0&vd_source=21b78eb73d808f842c3ff2485f3933ab)

#### 卡尔曼滤波的五个公式

**1.状态预测公式：**
$$
\hat{x}_k^-=A\hat{x}_{k-1}+B{u}_k\\
$$
　　考虑如下情境，已知一个物体当前坐标、速度、加速度。其中，k-1时刻的坐标、速度被记录在$\hat{x}_{k-1}$中。矩阵A为状态转移矩阵，在该情境下，记录了从k-1时刻到k时刻速度对于距离的作用。例如：
$$
A=\begin{pmatrix}
1 & \Delta t\\
0 & 1
\end{pmatrix}
=
\begin{pmatrix}
1 & 1\\
0 & 1
\end{pmatrix}
,\
\hat{x}_{k-1}=
\begin{pmatrix}
15 \\
5
\end{pmatrix}
$$
　　该式中，$\hat{x}_{k-1}$的两数分别表示当前的位置和速度。可以发现，计算后得到的，对时刻k的状态的估计值$\hat{x}_{k}^-$的第一行值为20，表达的含义为，从k-1时刻到k时刻，仅考虑恒定速度的情况下，经过一单位的时间，预测坐标从15变为15+5=20。而速度维持不变。

　　所以，状态转移矩阵A描述的是基于当前的已知输入量，预测得到的状态变化。

　　但同时，输入量也会随时间变化。在上述情境中，这一变化表现为加速度。

　　$u_k$描述的是系统的控制输入，例如外部力量或系统的控制指令。矩阵B是控制输入矩阵，描述了控制输入如何影响系统状态。在上述情境中，可被写为：
$$
B=
\begin{pmatrix}
\frac{\Delta t^2}{2}\\
\Delta t
\end{pmatrix}
=
\begin{pmatrix}
0.5 \\
1
\end{pmatrix}
,\
u_k=2
$$
　　该式中，B分别表达了加速度对于坐标和速度的影响；$u_k$则表示加速度为2。将上述两式结合可得：
$$
\hat{x}_k^-=
\begin{pmatrix}
1 & 1\\
0 & 1
\end{pmatrix}
\begin{pmatrix}
15 \\
5
\end{pmatrix}
+
2
\begin{pmatrix}
0.5 \\
1
\end{pmatrix}
=
\begin{pmatrix}
21\\
7
\end{pmatrix}
$$
　　即基于目前（k-1时刻）所有已知量得到的k时刻状态的预测值：坐标变为21，速度变为7。

　　这是一般的状态预测方法的公式。但它的问题在于，只能根据当前的已知量求出一个确定的解，无法优化系统中未知的噪声对于状态的影响。

　　在实际的情境中，基于前一状态的计算得到的新状态值会受到过程噪声的影响，从而导致数据不准确。基于传感器直接测得的状态值也会受到测量噪声的影响，导致测量值也不准确。

　　**卡尔曼滤波器的核心思想就是：虽然测量值和预测值都不准确，但两者的噪声对数据的影响都近似满足正态分布。因此，我们只需找到一个参数$K_k$，分别以$K_k$和$(1-K_k)$的比例倾向于相信测量值和预测值，使得将两者结合后得到的新的正态分布的方差最小。那么这个值就最有可能接近我们期望的值。（此处可能有些绕，如果不能理解，请回看卡尔曼滤波器视频中的P2）**

**2.协方差预测公式：**
$$
P_k^-=AP_{k-1}A^T+Q\\
$$
　　在上一步中，我们得到了估计值。但我们并不清楚这一先验值的误差有多少。于是我们希望通过递推的方法，从上一时刻的协方差矩阵推出当前时刻的协方差矩阵的先验值。

　　公式的直观理解：$P_{k-1}$表示在时刻k-1我们对系统状态的估计误差的不确定性。随着时间的推移，这个误差通过状态转移矩阵A被传播到时刻k。过程噪声协方差矩阵Q是描述系统内部不确定性和外部干扰的矩阵，表示系统动态模型未能完全捕捉到的随机扰动或误差。

　　直观理解仅作为辅助理解公式的作用，若想了解公式的推导，请回看卡尔曼滤波器视频中的P4。

**3.卡尔曼增益计算公式：**
$$
K_k=P_k^-H^T(HP_k^-H^T+R)^{-1}\\
$$
　　**卡尔曼增益$K_k$是卡尔曼滤波器的核心参数。**若不理解该值是如何得到的，请回看卡尔曼滤波器视频中的P3。

　　直观来说，当观测噪声协方差矩阵$R \rightarrow \infty$，$K_k \rightarrow 0$，结合公式4，最终得到$\hat{x}_k \rightarrow \hat{x}_k^-$，即倾向于相信先验估计值；当观测噪声协方差矩阵$R \rightarrow 0$，$K_k \rightarrow H^-$，结合公式4，最终得到$\hat{x}_k \rightarrow H^-z_k$，即倾向于相信测量值。

**4.状态更新公式：**
$$
\hat{x}_k=\hat{x}_k^-+K_k(z_k-H\hat{x}_k^-)\\
$$
　　基于得到的卡尔曼增益$K_k$，我们找到了结合观测值和估计值的最佳比例，由此得到了一个理论上最可能接近真实值的预测值$\hat{x}_k$。

**5.协方差更新公式：**
$$
P_k=(I-K_kH)P_k^-\\
$$
　　注意到公式2中，在计算$P_k^-$时，用到了$P_{k-1}$。那么为了下一轮的计算，需要更新协方差矩阵。

### 平衡小车中卡尔曼滤波器的应用

　　如之前所说，我们有两种得到小车当前姿态的方式，分别为：

　　①通过角速度对时间的积分得到各轴目前的角度值

　　②通过各轴的加速度解算角度值

　　这就对应了卡尔曼滤波器中的先验估计值和观测值。显然，积分方法得到的角度值属于先验估计值，而加速度解算得到的角度值属于观测值。

　　那么，我们就可以分步写出上面的五个公式：

**1.状态预测公式：**
$$
\hat{x}_k^-=A\hat{x}_{k-1}+B{u}_k=
\begin{pmatrix}
1 & 0\\
0 & 0
\end{pmatrix}
\hat{x}_{k-1}
+
\begin{pmatrix}
\Delta t\\
0
\end{pmatrix}
\omega_x
$$
　　注意到这里并没有使用角加速度，而是仅通过角速度值得到角度的先验估计值。所以公式与前面的介绍有所不同。需要指出的是，在平衡小车卖家给出的参考文档中，这一公式被写为：
$$
\hat{x}_k^-=A\hat{x}_{k-1}+B{u}_k=
\begin{pmatrix}
1 & -\Delta t\\
0 & 1
\end{pmatrix}
\hat{x}_{k-1}
+
\begin{pmatrix}
\Delta t\\
0
\end{pmatrix}
\omega_x
$$
　　但实际上，$\hat{x}_{k-1}$矩阵中的第二项恒为0，将A矩阵中第二列的值改为0不影响计算。目前不清楚他们这样写的目的，可能是为了数学上的严谨性（？）

**2.协方差预测公式：**
$$
P_k^-=AP_{k-1}A^T+Q\\
$$
　　其中的Q矩阵，参数需要我们调试。但这一调试过程非常复杂且没有明确的理论指导。这里给出参考值：
$$
Q=
\begin{pmatrix}
10^{-10} & 0\\
0 & 10^{-10}
\end{pmatrix}
$$
　　各位亦可自行尝试一些接近的值，但不宜离这个值偏差太大，**尤其是在还没有完全调试好小车的时候**。否则小车会出现奇怪的行为，这时候很难排查出错误的原因。

**3.卡尔曼增益计算公式：**
$$
K_k=P_k^-H^T(HP_k^-H^T+R)^{-1}\\
$$
　　这里的矩阵：
$$
H=
\begin{pmatrix}
1 & 0
\end{pmatrix}
$$
　　观测值协方差矩阵：
$$
R=
\begin{pmatrix}
10^{-4}
\end{pmatrix}
$$
　　因为H矩阵的第二项为0，所以$HP_k^-H^T$得到的就是$P_k^-$左上角的值，所以矩阵$R$只需要1x1的矩阵即可。而求逆在1x1的矩阵中等价于取倒数。所以，此处不需要矩阵求逆的算法。

**4.状态更新公式：**
$$
\hat{x}_k=\hat{x}_k^-+K_k(z_k-H\hat{x}_k^-)\\
$$
　　此处的$z_k$是通过加速度计算得到的角度值。对于x轴的角度值，只需获取y，z轴的加速度值。这里调用了stm32自带的数学库中的函数`atan2()`。具体步骤如下：

　　①Keil魔术棒的C/C++选项内，Define一栏加入ARM_MATH_CM3宏定义

　　②main.c文件中引用arm_math.h文件

　　③于Start文件夹下删除Core中的core_cm3.h函数（目的是避免函数重复定义）

　　这样就可以在编程时直接调用`atan2()`函数了。

　　最后将加速度计算得到的角度值与先验估计值相减，乘上卡尔曼增益即可。

**5.协方差更新公式：**
$$
P_k=(I-K_kH)P_k^-\\
$$
　　这一块是为下一轮计算准备协方差矩阵。

　　对于平衡小车，我们实际上只关心x轴的角度值，即俯仰角（pitch）的值。y轴横滚角（roll）的值也可以通过卡尔曼滤波的方式较为准确地计算（虽对于基础的平衡小车而言并无用处）。然而，偏航角（yaw）的值则无法通过六轴姿态传感器准确得到。这是因为加速度计在测量偏航角时无法提供参考。（具体原因可自行思考）

　　至此理论上可以写出卡尔曼滤波器的程序。

　　如果在写程序时遇到困难（99.99%会遇到困难），可以参考商家给出的程序中的`KF.c`和`KF.h`文件。调用时注意删除`KF.h`中的`#include sys.h`语句。因为本教程是基于江协科技的项目结构，没有sys文件。
